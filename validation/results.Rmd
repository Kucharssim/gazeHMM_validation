---
title: "Results validation"
author: "Malte LÃ¼ken"
date: "31.05.2020"
output: ioslides_presentation
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(psych)
library(depmixS4)
library(knitr)
library(kableExtra)

source("~/Uni/Psychologie Master/Internship/GazeHMM/algorithm/model_helper_functions.R")

```

# Data set Andersson et al. (2017)

```{r load data and compute metrics, include=FALSE}

# Load data

load("~/Uni/Psychologie Master/Internship/GazeHMM/validation/Andersson2017_fitted.Rdata")
load("~/Uni/Psychologie Master/Internship/GazeHMM/validation/Andersson2017_raw.Rdata")


# Compute Schwarz weights

schwarz.weights <- function(bic, na.rm = T) {
  
  d.bic <- bic - min(bic, na.rm = na.rm) # eq 2
  
  exp(-0.5 * d.bic)/sum(exp(-0.5 * d.bic), na.rm = na.rm) # eq 4
  
}

A2017.bic <- lapply(A2017.fit, function(stim) {
  out <- lapply(stim, function(subj) {
    out <- lapply(1:length(subj), function(mod) {
      
      if(mod == 1) {
        
        bic <- try(-2*subj[[mod]][["LL"]] + 6*log(subj[[mod]][["N"]]))
        
      } else {
        
        bic <- try(BIC(subj[[mod]]$model))
        
      }
      
      return(ifelse(is.numeric(bic), bic, NA))
    })
    
    return(schwarz.weights(unlist(out)))
  })
  
  df <- as.data.frame(reduce(out, rbind))
  
  names(df) <- paste("model_", 1:length(stim[[1]]), sep = "")
  
  return(df)
})


# Create Schwarz weight plots

bic.plot <- lapply(A2017.bic, function(x) {
  
  data.long <- x %>% 
    mutate(subject = 1:nrow(x)) %>%
    pivot_longer(names(x), names_to = "model", values_to = "weight") %>%
    mutate_at(c("subject", "model"), as.factor)
  
  p <- ggplot(data.long, aes(x = model, y = subject)) + geom_tile(aes(fill = weight)) +
    scale_fill_continuous(name = "Schwarz\nweight") +
    scale_x_discrete(name = "Number of states in model", labels = as.character(1:5))
  
  return(p)
})


# Calculate event descriptives for human coders

fr <- 500

A2017.events <- lapply(A2017, function(stim) {
  lapply(1:4, function(e) {
    out <- lapply(stim, function(df) {
      
      if(all(is.nan(df$t) || df$t == 0)) {
        
        df$t <- seq(0, length(df$t)-1)/fr
        
      } else {
        
        df$t <- (df$t - df$t[1])/1e6
        
        df <- df[df$t >= 0,]
        
      }
      
      counter_MN <- 1
      counter_RA <- 1
      
      number_MN <- numeric(nrow(df))
      number_RA <- numeric(nrow(df))
      
      number_MN[1] <- 1
      number_RA[1] <- 1
      
      for (i in 2:nrow(df)) {
        if(df$label_MN[i] != df$label_MN[i-1]) counter_MN <- counter_MN + 1
        if(df$label_RA[i] != df$label_RA[i-1]) counter_RA <- counter_RA + 1
        
        number_MN[i] <- counter_MN
        number_RA[i] <- counter_RA
    
      }
      
      dur_MN <- numeric(max(number_MN))
      event_MN <- numeric(max(number_MN))
      
      for (n in unique(number_MN)) {
        if(n > 1) {
          dur_MN[n] <- max(df$t[number_MN == n], na.rm = T) - max(df$t[number_MN == (n-1)], na.rm = T)
        } else {
          dur_MN[n] <- max(df$t[number_MN == n], na.rm = T) - min(df$t[number_MN == n], na.rm = T)
        }
        
        event_MN[n] <- max(df$label_MN[number_MN == n], na.rm = T)
      }
      
      dur_RA <- numeric(max(number_RA))
      event_RA <- numeric(max(number_RA))
      
      for (n in unique(number_RA)) {
        if(n > 1) {
          dur_RA[n] <- max(df$t[number_RA == n], na.rm = T) - max(df$t[number_RA == (n-1)], na.rm = T)
        } else {
          dur_RA[n] <- max(df$t[number_RA == n], na.rm = T) - min(df$t[number_RA == n], na.rm = T)
        }
        
        event_RA[n] <- max(df$label_RA[number_RA == n], na.rm = T)
      }
      
      return(list(dur_MN[event_MN == e], dur_RA[event_RA == e]))
    })
    
    df <- reduce(out, cbind)
    
    dur_MN <- unlist(df[1,])
    dur_RA <- unlist(df[2,])
    
    return(data.frame(MN = c(mean(dur_MN), sd(dur_MN), length(dur_MN)),
                      RA = c(mean(dur_RA), sd(dur_RA), length(dur_RA))))
  })
})


# Calculate RMSD between event distribution descriptives

ref <- list(dot = list(fix = list(CDT = c(60, 127, 165),
                                  EM = c(NA, NA, NA),
                                  IDT = c(323, 146, 8),
                                  IKF = c(217, 184, 72),
                                  IMST = c(268, 140, 12),
                                  IHMM = c(214, 286, 67),
                                  IVT = c(203, 282, 71),
                                  NH = c(380, 333, 30),
                                  BIT = c(189, 113, 67),
                                  LNS = c(NA, NA, NA)),
                       sac = list(CDT = c(NA, NA, NA),
                                  EM = c(17, 14, 93),
                                  IDT = c(32, 14, 10),
                                  IKF = c(60, 26, 29),
                                  IMST = c(13, 5, 18),
                                  IHMM = c(41, 17, 27),
                                  IVT = c(36, 14, 28),
                                  NH = c(43, 16, 42),
                                  BIT = c(NA, NA, NA),
                                  LNS = c(26, 11, 53)),
                       pso = list(NH = c(24, 12, 17),
                                  LNS = c(20, 9, 31))),
            img = list(fix = list(CDT = c(397, 559, 251),
                                  EM = c(NA, NA, NA),
                                  IDT = c(399, 328, 242),
                                  IKF = c(174, 239, 513),
                                  IMST = c(304, 293, 333),
                                  IHMM = c(133, 216, 701),
                                  IVT = c(114, 204, 827),
                                  NH = c(258, 299, 292),
                                  BIT = c(209, 136, 423),
                                  LNS = c(NA, NA, NA)),
                       sac = list(CDT = c(NA, NA, NA),
                                  EM = c(25, 22, 787),
                                  IDT = c(25, 15, 258),
                                  IKF = c(62, 37, 353),
                                  IMST = c(17, 10, 335),
                                  IHMM = c(48, 26, 368),
                                  IVT = c(41, 22, 373),
                                  NH = c(50, 20, 344),
                                  BIT = c(NA, NA, NA),
                                  LNS = c(29, 12, 390)),
                       pso = list(NH = c(28, 13, 237),
                                  LNS = c(25, 9, 319))),
            vid = list(fix = list(CDT = c(213, 297, 211),
                                  EM = c(NA, NA, NA),
                                  IDT = c(554, 454, 48),
                                  IKF = c(258, 296, 169),
                                  IMST = c(526, 825, 71),
                                  IHMM = c(234, 319, 194),
                                  IVT = c(202, 306, 227),
                                  NH = c(429, 336, 83),
                                  BIT = c(248, 215, 170),
                                  LNS = c(NA, NA, NA)),
                       sac = list(CDT = c(NA, NA, NA),
                                  EM = c(20, 16, 252),
                                  IDT = c(24, 53, 41),
                                  IKF = c(55, 20, 107),
                                  IMST = c(18, 10, 76),
                                  IHMM = c(42, 18, 109),
                                  IVT = c(36, 16, 112),
                                  NH = c(44, 18, 104),
                                  BIT = c(NA, NA, NA),
                                  LNS = c(28, 12, 122)),
                       pso = list(NH = c(28, 13, 78),
                                  LNS = c(24, 10, 87))))


A2017.rmsd <- lapply(2:4, function(k) {
  lapply(1:length(A2017.fit), function(x) { 
    out <- lapply(1:k, function(y) {
      out <- lapply(A2017.fit[[x]], function(z) {
        
        if(class(z[[k]]) == "gazeHMM") z[[k]]$events[[y]]
        
      })
      
      df <- try(reduce(out, rbind))
      
      alg <- try(c(mean(df$dur, na.rm = T), sd(df$dur, na.rm = T), nrow(df)))
      
      if(y == 4) {
        M <- try(cbind(A2017.events[[x]][[y]], alg))
      } else {
        M <- try(cbind(A2017.events[[x]][[y]], alg, as.data.frame(ref[[x]][[y]])))
        M[1:2,4:ncol(M)] <- M[1:2,4:ncol(M)]/1e3
      }
      
      M.norm <- try(apply(M, 1, function(x) {(x - min(x, na.rm = T))/(max(x, na.rm = T) - min(x, na.rm = T))}))
      
      if(y == 4) {
        rmsd <- try(sum(sqrt((M.norm[3,] - colSums(M.norm[1:2,]/2))^2)))
      } else {
        rmsd <- try(apply(M.norm[3:nrow(M.norm),], 1, function(r) {sum(sqrt((r - colSums(M.norm[1:2,]/2))^2))}))
      }
      
      coder <- try(sum(sqrt((M.norm[1,] - M.norm[2,])^2)))
      
      rmsd <- c(coder, coder, rmsd)
      
      return(rbind(M, rmsd))
    })
  })
})


# Create tables for RMSDs

rmsd.table <- lapply(A2017.rmsd, function(x) {
  lapply(x, function(y) {
    lapply(y, function(z) {
      
      tabmat <- t(apply(z, 2, function(d) {as.character(round(d, 3))}))
      
      tabmat[3,] <- paste("**", tabmat[3,], "**", sep = "")
      
      colnames(tabmat) <- c("Mean dur", "SD dur", "# events", "RMSD")
      rownames(tabmat)[1:3] <- c("coderMN", "coderRA", "gazeHMM")
      
      return(kable(tabmat, align = "r") %>% kable_styling(font_size = 14))
    })
  })
})


# Compute Cohen's kappa and confusion matrices

A2017.acc <- lapply(2:4, function(k) {
  lapply(1:length(A2017.fit), function(x) { 
    out <- lapply(1:length(A2017.fit[[x]]), function(y) {
      
      if(class(A2017.fit[[x]][[y]][[as.character(k)]]) == "gazeHMM") {
        cod.MN <- as.data.frame(cbind(A2017.fit[[x]][[y]][[as.character(k)]]$samples$label, A2017[[x]][[y]]$label_MN))
        cod.RA <- as.data.frame(cbind(A2017.fit[[x]][[y]][[as.character(k)]]$samples$label, A2017[[x]][[y]]$label_RA))
        
        return(rbind(cod.MN, cod.RA))
      }
    })
    
    df <- reduce(out, rbind)
    
    df[df[,1] == 0,1] <- 5
    
    events <- lapply(1:k, function(e) {
      
      alg <- df[,1] == e
      cod <- df[,2] == e
      
      mat <- matrix(c(sum(alg & cod, na.rm = T), sum(alg & !cod, na.rm = T), 
                      sum(!alg & cod, na.rm = T), sum(!alg & !cod, na.rm = T)), 2, 2)
      
      over <- mat[2,1]/sum(mat[,1])
      under <- mat[1,2]/sum(mat[,2])
      
      return(list(kappa = cohen.kappa(mat)$kappa, 
                  over = over,
                  under = under))
    })
    
    ratio <- mean(df[,1] != df[,2], na.rm = T)
    
    conmat <- table(df[,1], df[,2])
    
    return(list(events = events, ratio =  ratio, conmat = conmat))
  })
})


# Create tables for Cohen's kappa and confusion matrices

kappa.table <- lapply(A2017.acc, function(x) {
  out <- lapply(x, function(y){
    out <- lapply(y$events, function(z){
      return(round(z$kappa, 3))
    })
    
    return(reduce(out, cbind))
  })
  
  tabmat <- reduce(out, rbind)
  
  tabmat <- apply(tabmat, 2, as.character)
  
  colnames(tabmat) <- c("Fixations", "Saccades", "PSOs", "Smooth pursuits")[1:ncol(tabmat)]
  rownames(tabmat) <- c("Dots", "Image", "Video")
  
  return(kable(tabmat, align = "r") %>% kable_styling(font_size = 14))
})

conf.table <- lapply(A2017.acc, function(x) {
  out <- lapply(x, function(y){
    
    tabmat <- apply(y$conmat, 2, as.character)
    
    diag(tabmat)[1:(nrow(tabmat)-1)] <- paste("**", diag(tabmat)[1:(nrow(tabmat)-1)], "**", sep = "")
    
    tabmat[nrow(tabmat), 5] <- paste("**", tabmat[nrow(tabmat), 5], "**", sep = "")

    colnames(tabmat) <- c("Fixations", "Saccades", "PSOs", "Smooth pursuits", "Blinks", "Other")
    rownames(tabmat) <- c("Fixations", "Saccades", "PSOs", "Smooth pursuits", "Blinks", "Other")[1:nrow(tabmat)]
    rownames(tabmat)[nrow(tabmat)] <- "Blinks"

    return(kable(as.data.frame(tabmat), align = "r") %>% kable_styling(font_size = 14))
  })
})

```

## Model Comparison (Schwarz weight)
### Image

```{r}
print(bic.plot[[2]])
```

## Model Comparison (Schwarz weight)
### Moving dot

```{r}
print(bic.plot[[1]])
```

## Model Comparison (Schwarz weight)
### Video

```{r}
print(bic.plot[[3]])
```

## Event Durations
### 2-state Model
#### Image - Fixations

```{r, results="asis"}
print(rmsd.table[[1]][[2]][[1]])
```

## Event Durations
### 2-state Model
#### Image - Saccades

```{r, results="asis"}
print(rmsd.table[[1]][[2]][[2]])
```

## Event Durations
### 2-state Model
#### Dots - Fixations

```{r, results="asis"}
print(rmsd.table[[1]][[1]][[1]])
```

## Event Durations
### 2-state Model
#### Dots - Saccades

```{r, results="asis"}
print(rmsd.table[[1]][[1]][[2]])
```

## Event Durations
### 2-state Model
#### Video - Fixations

```{r, results="asis"}
print(rmsd.table[[1]][[3]][[1]])
```

## Event Durations
### 2-state Model
#### Video - Saccades

```{r, results="asis"}
print(rmsd.table[[1]][[3]][[2]])
```

## Event Durations
### 3-state Model
#### Image - Fixations

```{r, results="asis"}
print(rmsd.table[[2]][[2]][[1]])
```

## Event Durations
### 3-state Model
#### Image - Saccades

```{r, results="asis"}
print(rmsd.table[[2]][[2]][[2]])
```

## Event Durations
### 3-state Model
#### Image - PSOs

```{r, results="asis"}
print(rmsd.table[[2]][[2]][[3]])
```

## Event Durations
### 3-state Model
#### Dots - Fixations

```{r, results="asis"}
print(rmsd.table[[2]][[1]][[1]])
```

## Event Durations
### 3-state Model
#### Dots - Saccades

```{r, results="asis"}
print(rmsd.table[[2]][[1]][[2]])
```

## Event Durations
### 3-state Model
#### Dots - PSOs

```{r, results="asis"}
print(rmsd.table[[2]][[1]][[3]])
```

## Event Durations
### 3-state Model
#### Video - Fixations

```{r, results="asis"}
print(rmsd.table[[2]][[3]][[1]])
```

## Event Durations
### 3-state Model
#### Video - Saccades

```{r, results="asis"}
print(rmsd.table[[2]][[3]][[2]])
```

## Event Durations
### 3-state Model
#### Video - PSOs

```{r, results="asis"}
print(rmsd.table[[2]][[3]][[3]])
```

## Event Durations
### 4-state Model
#### Image - Fixations

```{r, results="asis"}
print(rmsd.table[[3]][[2]][[1]])
```

## Event Durations
### 4-state Model
#### Image - Saccades

```{r, results="asis"}
print(rmsd.table[[3]][[2]][[2]])
```

## Event Durations
### 4-state Model
#### Image - PSOs

```{r, results="asis"}
print(rmsd.table[[3]][[2]][[3]])
```

## Event Durations
### 4-state Model
#### Image - Smooth pursuits

```{r, results="asis"}
print(rmsd.table[[3]][[2]][[4]])
```

## Event Durations
### 4-state Model
#### Dots - Fixations

```{r, results="asis"}
print(rmsd.table[[3]][[1]][[1]])
```

## Event Durations
### 4-state Model
#### Dots - Saccades

```{r, results="asis"}
print(rmsd.table[[3]][[1]][[2]])
```

## Event Durations
### 4-state Model
#### Dots - PSOs

```{r, results="asis"}
print(rmsd.table[[3]][[1]][[3]])
```

## Event Durations
### 4-state Model
#### Dots - Smooth pursuits

```{r, results="asis"}
print(rmsd.table[[3]][[1]][[4]])
```

## Event Durations
### 4-state Model
#### Video - Fixations

```{r, results="asis"}
print(rmsd.table[[3]][[3]][[1]])
```

## Event Durations
### 4-state Model
#### Video - Saccades

```{r, results="asis"}
print(rmsd.table[[3]][[3]][[2]])
```

## Event Durations
### 4-state Model
#### Video - PSOs

```{r, results="asis"}
print(rmsd.table[[3]][[3]][[3]])
```

## Event Durations
### 4-state Model
#### Video - Smooth pursuits

```{r, results="asis"}
print(rmsd.table[[3]][[3]][[4]])
```

## Agreement with Human Coders (Cohen's kappa)
### 2-state Model

```{r, results='asis'}
print(kappa.table[[1]])
```

## Agreement with Human Coders (Cohen's kappa)
### 3-state Model

```{r, results='asis'}
print(kappa.table[[2]])
```

## Agreement with Human Coders (Cohen's kappa)
### 4-state Model

```{r, results='asis'}
print(kappa.table[[3]])
```

## Agreement with Human Coders (Confusion Matrix)
### 2-state Model
#### Dots

```{r, results='asis'}
print(conf.table[[1]][[1]])
```

## Agreement with Human Coders (Confusion Matrix)
### 2-state Model
#### Image

```{r, results='asis'}
print(conf.table[[1]][[2]])
```

## Agreement with Human Coders (Confusion Matrix)
### 2-state Model
#### Video

```{r, results='asis'}
print(conf.table[[1]][[3]])
```

## Agreement with Human Coders (Confusion Matrix)
### 3-state Model
#### Dots

```{r, results='asis'}
print(conf.table[[2]][[1]])
```

## Agreement with Human Coders (Confusion Matrix)
### 3-state Model
#### Image

```{r, results='asis'}
print(conf.table[[2]][[2]])
```

## Agreement with Human Coders (Confusion Matrix)
### 3-state Model
#### Video

```{r, results='asis'}
print(conf.table[[2]][[3]])
```

## Agreement with Human Coders (Confusion Matrix)
### 4-state Model
#### Dots

```{r, results='asis'}
print(conf.table[[3]][[1]])
```

## Agreement with Human Coders (Confusion Matrix)
### 4-state Model
#### Image

```{r, results='asis'}
print(conf.table[[3]][[2]])
```

## Agreement with Human Coders (Confusion Matrix)
### 4-state Model
#### Video

```{r, results='asis'}
print(conf.table[[3]][[3]])